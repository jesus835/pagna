<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamed - Partidos en Vivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2d2d2d;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        h1 {
            text-align: center;
            color: #00ff88;
            font-size: 2.5rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #00cc6a;
        }
        
        select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 12px;
            border-radius: 5px;
            min-width: 150px;
        }
        
        #teamSearch {
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        #teamSearch:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 5px rgba(255, 107, 53, 0.3);
        }
        
        #teamSearch::placeholder {
            color: #888;
        }
        
        .matches {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .match {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .league {
            background: #00ff88;
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status.live {
            background: #ff4444;
            color: white;
        }
        
        .status.upcoming {
            background: #ffaa00;
            color: #000;
        }
        
        .status.finished {
            background: #666;
            color: white;
        }
        
        .teams {
            text-align: center;
            margin: 20px 0;
        }
        
        .team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
        
        .score {
            background: #00ff88;
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .watch-btn {
            width: 100%;
            background: #0066cc;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .watch-btn:hover {
            background: #0052a3;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background: #2d2d2d;
            margin: 0;
            padding: 0;
            border-radius: 0;
            width: 100%;
            height: 100vh;
            max-width: none;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 20px 15px 20px;
            border-bottom: 2px solid #444;
        }
        
        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: #444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close:hover {
            color: white;
            background: #ff4444;
            transform: scale(1.1);
        }
        
        
        .stream-player {
            background: #000;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .matches {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÜ Futbol Libre - Partidos en Vivo</h1>
        </header>
        
        <div class="controls">
            <button onclick="loadMatches()">Cargar Partidos</button>
            <button onclick="loadLiveMatches()">Solo En Vivo</button>
            <button onclick="showFootballOnly()">Solo F√∫tbol</button>
            <button onclick="loadAllSports()">Ver Todos los Deportes</button>
            <input type="text" id="teamSearch" placeholder="Buscar por equipo (ej: Barcelona)" onkeyup="searchByTeam()" style="padding: 8px; border: 1px solid #444; border-radius: 4px; background: #333; color: white; margin: 0 5px;">
            <button onclick="clearSearch()" style="background: #666; color: white; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Limpiar</button>
            <select id="sportFilter" onchange="filterBySport()">
                <option value="">Todas las categor√≠as</option>
            </select>
            <select id="leagueFilter" onchange="filterByLeague()">
                <option value="">Todas las categor√≠as</option>
            </select>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            Cargando partidos...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="matches" class="matches">
            <!-- Los partidos se cargar√°n aqu√≠ -->
        </div>
    </div>
    
    <!-- Modal para ver stream -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ver Partido</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="stream-player" id="streamPlayer">
                <!-- Reproductor de video -->
            </div>
        </div>
    </div>
    
    <!-- Stream Overlay -->
    <div id="streamOverlay" class="stream-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000;">
        <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #111; color: #fff;">
                <div style="font-weight: 700;">Stream en Vivo</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="adTimer" style="color: #ff6b35; font-weight: 700; display: none;">Cargando publicidad... <span id="countdown">5</span>s</div>
                    <button id="closeAdBtn" onclick="closeAdAndShowStream()" style="background: #ff6b35; color: #000; border: none; padding: 6px 10px; border-radius: 4px; font-weight: 700; cursor: pointer; display: none;">Cerrar Publicidad</button>
                    <button id="closeStreamBtn" onclick="closeStreamOverlay()" style="background: #ff6b35; color: #000; border: none; padding: 6px 10px; border-radius: 4px; font-weight: 700; cursor: pointer; display: none;">Cerrar Stream</button>
                </div>
            </div>
            <div id="adContainer" style="flex: 1; width: 100%; background: #000; display: none;">
                <iframe id="adIframe" src="" style="width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>
            </div>
            <iframe id="streamIframe" src="" style="flex: 1; width: 100%; border: 0; background: #000; display: none;" allowfullscreen></iframe>
        </div>
    </div>
    
    <script>
        // Configuraci√≥n de la API de Streamed
        const API_BASE = 'https://streamed.pk/api';
        let currentMatches = [];
        
        // Cargar partidos
        async function loadMatches() {
            showLoading(true);
            hideError();
            
            try {
                console.log('=== INICIANDO CARGA DE PARTIDOS ===');
                console.log('API_BASE:', API_BASE);
                
                // Primero obtener deportes disponibles
                console.log('Obteniendo deportes...');
                const sportsResponse = await fetch(`${API_BASE}/sports`);
                console.log('Respuesta deportes:', sportsResponse.status, sportsResponse.ok);
                
                if (!sportsResponse.ok) {
                    throw new Error(`Error ${sportsResponse.status}: ${sportsResponse.statusText}`);
                }
                
                const sports = await sportsResponse.json();
                console.log('Deportes obtenidos:', sports);
                
                if (sports.length === 0) {
                    showError('No hay deportes disponibles');
                    return;
                }
                
                // Buscar f√∫tbol primero, si no existe usar el primer deporte
                let selectedSport = sports.find(sport => sport.id === 'football' || sport.name.toLowerCase().includes('football') || sport.name.toLowerCase().includes('soccer'));
                if (!selectedSport) {
                    selectedSport = sports[0];
                }
                
                console.log('Deporte seleccionado:', selectedSport);
                console.log('Cargando partidos para deporte ID:', selectedSport.id);
                
                const response = await fetch(`${API_BASE}/matches/${selectedSport.id}`);
                console.log('Respuesta partidos:', response.status, response.ok);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Partidos obtenidos:', data);
                console.log('Cantidad de partidos:', data.length);
                
                currentMatches = data;
                displayMatches(data);
                populateFilters(data, sports);
            } catch (error) {
                console.error('Error completo:', error);
                showError('Error al cargar partidos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Cargar solo partidos en vivo
        async function loadLiveMatches() {
            showLoading(true);
            hideError();
            
            try {
                console.log('=== CARGANDO PARTIDOS EN VIVO ===');
                console.log('URL:', `${API_BASE}/matches/live`);
                
                const response = await fetch(`${API_BASE}/matches/live`);
                console.log('Respuesta partidos en vivo:', response.status, response.ok);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Partidos en vivo obtenidos:', data);
                console.log('Cantidad de partidos en vivo:', data.length);
                
                currentMatches = data;
                displayMatches(data);
                
                // Obtener deportes para los filtros
                const sportsResponse = await fetch(`${API_BASE}/sports`);
                const sports = await sportsResponse.json();
                populateFilters(data, sports);
            } catch (error) {
                console.error('Error cargando partidos en vivo:', error);
                showError('Error al cargar partidos en vivo: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Mostrar partidos
        function displayMatches(matches) {
            const container = document.getElementById('matches');
            container.innerHTML = '';
            
            if (!matches || matches.length === 0) {
                container.innerHTML = '<div class="error">No hay partidos disponibles</div>';
                return;
            }
            
            // Filtrar solo partidos del d√≠a actual
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
            const todayEnd = todayStart + (24 * 60 * 60 * 1000); // 24 horas despu√©s
            
            const todayMatches = matches.filter(match => {
                // Incluir partidos en vivo (fecha = 0)
                if (match.date === 0) return true;
                
                // Incluir partidos del d√≠a actual
                return match.date >= todayStart && match.date < todayEnd;
            });
            
            console.log(`Partidos del d√≠a: ${todayMatches.length} de ${matches.length} total`);
            console.log('Fecha actual:', today.toLocaleDateString('es-ES'));
            
            // Debug: mostrar estructura de datos en consola
            console.log('Estructura de datos de partidos:', todayMatches);
            if (todayMatches.length > 0) {
                console.log('Ejemplo de partido:', todayMatches[0]);
                console.log('Campos disponibles:', Object.keys(todayMatches[0]));
                
                // Debug de fechas
                console.log('=== DEBUG FECHAS ===');
                const now = Date.now();
                console.log('Fecha actual:', new Date(now).toLocaleString('es-ES'));
                
                todayMatches.slice(0, 5).forEach((match, index) => {
                    const matchDate = new Date(match.date);
                    const status = getMatchStatus(match);
                    console.log(`Partido ${index + 1}:`, {
                        title: match.title,
                        date: match.date,
                        formattedDate: matchDate.toLocaleString('es-ES'),
                        status: status,
                        isPast: match.date < now,
                        isFuture: match.date > now
                    });
                });
            }
            
            todayMatches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match';
                
                const status = getMatchStatus(match);
                const statusClass = status.toLowerCase();
                
                // Extraer equipos del t√≠tulo
                const titleParts = match.title.split(' vs ');
                const team1 = titleParts[0] || 'Equipo 1';
                const team2 = titleParts[1] || 'Equipo 2';
                
                // Obtener informaci√≥n de equipos si est√° disponible
                const homeTeam = match.teams?.home?.name || team1;
                const awayTeam = match.teams?.away?.name || team2;
                const homeScore = match.teams?.home?.score || '-';
                const awayScore = match.teams?.away?.score || '-';
                
                // Informaci√≥n de fuentes disponibles
                const sourcesInfo = match.sources && match.sources.length > 0 
                    ? `${match.sources.length} fuente${match.sources.length > 1 ? 's' : ''} disponible${match.sources.length > 1 ? 's' : ''}`
                    : 'Sin fuentes';

                matchDiv.innerHTML = `
                    <div class="match-header">
                        <span class="league">${match.category || 'Deporte'}</span>
                        <span class="status ${statusClass}">${status}</span>
                    </div>
                    <div class="teams">
                        <div class="team">
                            <span>${homeTeam}</span>
                            <span class="score">${homeScore}</span>
                        </div>
                        <div class="team">
                            <span>${awayTeam}</span>
                            <span class="score">${awayScore}</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 10px 0; font-size: 0.8rem; color: #888;">
                        ${sourcesInfo}
                    </div>
                    <button class="watch-btn" onclick="watchMatch('${match.id}')">
                        Ver Partido
                    </button>
                `;
                
                container.appendChild(matchDiv);
            });
        }
        
        // Determinar estado del partido
        function getMatchStatus(match) {
            const now = Date.now();
            const matchDate = match.date;
            
            // Si la fecha es 0, probablemente es un canal/stream especial
            if (matchDate === 0) {
                return 'EN VIVO';
            }
            
            // Convertir timestamp a milisegundos si es necesario
            const matchTime = matchDate > 1000000000000 ? matchDate : matchDate * 1000;
            
            // Si la fecha es en el pasado (m√°s de 2 horas), est√° finalizado
            if (matchTime < (now - 2 * 60 * 60 * 1000)) {
                return 'FINALIZADO';
            }
            
            // Si la fecha es en el pasado pero menos de 2 horas, probablemente en vivo
            if (matchTime < now) {
                return 'EN VIVO';
            }
            
            // Si la fecha es en el futuro, est√° pr√≥ximo
            return 'PR√ìXIMO';
        }
        
        // Ver partido
        async function watchMatch(matchId) {
            const match = currentMatches.find(m => m.id === matchId);
            if (!match) return;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const streamPlayer = document.getElementById('streamPlayer');
            
            modalTitle.textContent = match.title;
            
            // Agregar encabezado de streams al modal
            const streamHeader = document.createElement('div');
            streamHeader.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 20px 20px 0 20px;';
            streamHeader.innerHTML = `
                <h3 style="color: #00ff88; margin-bottom: 10px;">üì∫ Streams Disponibles</h3>
                <p style="color: #888; font-size: 0.9rem;">Selecciona el stream que prefieras</p>
            `;
            
            // Insertar el encabezado despu√©s del header del modal
            const modalContent = document.querySelector('.modal-content');
            modalContent.insertBefore(streamHeader, streamPlayer);
            
            streamPlayer.innerHTML = '<p>Cargando stream...</p>';
            modal.style.display = 'block';
            
            try {
                // Mostrar las fuentes de streaming disponibles
                if (match.sources && match.sources.length > 0) {
                    let streamsHTML = '';
                    
                    let streamCounter = 1;
                    let allStreams = [];
                    
                    // Cargar todos los streams de cada fuente
                    for (let i = 0; i < match.sources.length; i++) {
                        const source = match.sources[i];
                        
                        try {
                            const response = await fetch(`https://streamed.pk/api/stream/${source.source}/${source.id}`);
                            const streams = await response.json();
                            
                            if (streams && streams.length > 0) {
                                // Agregar streams a la lista general
                                streams.forEach(stream => {
                                    allStreams.push({
                                        ...stream,
                                        source: source.source,
                                        sourceId: source.id,
                                        streamNumber: streamCounter++
                                    });
                                });
                            }
                        } catch (error) {
                            console.error(`Error loading streams for ${source.source}:`, error);
                        }
                    }
                    
                    // Ordenar streams por espectadores (m√°s viewers primero)
                    allStreams.sort((a, b) => (b.viewers || 0) - (a.viewers || 0));
                    
                    // Mostrar todos los streams en una lista ordenada
                    if (allStreams.length > 0) {
                        streamsHTML += `
                            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #444; border-radius: 8px; background: #1a1a1a; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);">
                        `;
                        
                        // Agregar bot√≥n de recomendaci√≥n inteligente como PRIMER elemento
                        streamsHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #333; transition: background 0.3s; background: linear-gradient(135deg, #2a1a0a, #1a0f05);" 
                                 onmouseover="this.style.background='linear-gradient(135deg, #3a2a1a, #2a1f15)'" 
                                 onmouseout="this.style.background='linear-gradient(135deg, #2a1a0a, #1a0f05)'">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                                        <span style="color: #ff6b35; font-weight: bold; font-size: 1.1rem;">#0</span>
                                        <span style="color: #888; font-size: 0.7rem;">AI</span>
                                    </div>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="color: white; font-weight: 500;">üéØ Recomendaci√≥n Inteligente</span>
                                            <span style="background: #ff6b35; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">AUTO</span>
                                            <span style="font-size: 1.2rem;">üöÄ</span>
                                        </div>
                                        <div style="color: #888; font-size: 0.8rem;">
                                            ü§ñ Selecci√≥n autom√°tica del mejor stream
                                        </div>
                                    </div>
                                </div>
                                <button onclick="openBestStream('${matchId}', '${match.title}')" 
                                        style="background: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'">
                                    ‚ñ∂Ô∏è Abrir
                                </button>
                            </div>
                        `;
                        
                        allStreams.forEach((stream, index) => {
                            const language = stream.language || 'N/A';
                            const quality = stream.hd ? 'HD' : 'SD';
                            const viewers = stream.viewers || 0;
                            const isSpanish = language.toLowerCase() === 'spanish';
                            const isPopular = viewers > 100;
                            
                            // Colores seg√∫n caracter√≠sticas
                            let streamColor = '#00ff88';
                            let badgeColor = '#333';
                            let badgeText = '';
                            
                            if (isSpanish) {
                                streamColor = '#ff6b35';
                                badgeColor = '#ff6b35';
                                badgeText = 'üá™üá∏';
                            } else if (isPopular) {
                                streamColor = '#00ccff';
                                badgeColor = '#00ccff';
                                badgeText = 'üî•';
                            }
                            
                            streamsHTML += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #333; transition: background 0.3s;" 
                                     onmouseover="this.style.background='#2a2a2a'" 
                                     onmouseout="this.style.background='transparent'">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                                            <span style="color: ${streamColor}; font-weight: bold; font-size: 1.1rem;">#${index + 1}</span>
                                            <span style="color: #888; font-size: 0.7rem;">${stream.source.toUpperCase()}</span>
                                        </div>
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="color: white; font-weight: 500;">${language}</span>
                                                <span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">${quality}</span>
                                                ${badgeText ? `<span style="font-size: 1.2rem;">${badgeText}</span>` : ''}
                                            </div>
                                            <div style="color: #888; font-size: 0.8rem;">
                                                üë• ${viewers} espectadores
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="openSpecificStream('${stream.embedUrl}', '${match.title} - ${stream.source} - Stream ${index + 1}')" 
                                            style="background: ${streamColor}; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;"
                                            onmouseover="this.style.transform='scale(1.05)'" 
                                            onmouseout="this.style.transform='scale(1)'">
                                        ‚ñ∂Ô∏è Abrir
                                    </button>
                                </div>
                            `;
                        });
                        
                        streamsHTML += `</div>`;
                    } else {
                        streamsHTML += `
                            <div style="text-align: center; padding: 40px; color: #888;">
                                <div style="font-size: 3rem; margin-bottom: 15px;">üì∫</div>
                                <h4>No hay streams disponibles</h4>
                                <p>Intenta m√°s tarde o verifica la conexi√≥n</p>
                            </div>
                        `;
                    }
                    
                    streamPlayer.innerHTML = streamsHTML;
                } else {
                    // Fallback: intentar endpoint directo
                    const response = await fetch(`${API_BASE}/stream/${matchId}`);
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    
                    const streamData = await response.json();
                    
                    if (streamData.stream_url) {
                        streamPlayer.innerHTML = `
                            <video controls style="width: 100%; max-width: 600px;">
                                <source src="${streamData.stream_url}" type="video/mp4">
                                Tu navegador no soporta video.
                            </video>
                            <br><br>
                            <a href="${streamData.stream_url}" target="_blank" style="color: #00ff88;">
                                Abrir stream en nueva pesta√±a
                            </a>
                        `;
                    } else {
                        streamPlayer.innerHTML = '<p>Stream no disponible</p>';
                    }
                }
            } catch (error) {
                streamPlayer.innerHTML = `<p>Error cargando stream: ${error.message}</p>`;
            }
        }
        
        // Cerrar modal
        function closeModal() {
            const modal = document.getElementById('modal');
            const streamHeader = modal.querySelector('div[style*="text-align: center"]');
            if (streamHeader) {
                streamHeader.remove();
            }
            modal.style.display = 'none';
        }
        
        
        // Funci√≥n para abrir un stream espec√≠fico
        function openSpecificStream(embedUrl, title) {
            try {
                console.log('üéØ === openSpecificStream ===');
                console.log('üéØ embedUrl:', embedUrl);
                console.log('üéØ title:', title);
                console.log('üéØ embedUrl v√°lida:', embedUrl && embedUrl !== 'undefined');
                
                if (embedUrl && embedUrl !== 'undefined') {
                    console.log('üéØ Llamando a openStreamOverlay...');
                    openStreamOverlay(embedUrl, title);
                } else {
                    console.error('‚ùå URL de stream no v√°lida en openSpecificStream');
                    showError('URL de stream no v√°lida');
                }
                
            } catch (error) {
                console.error('‚ùå Error en openSpecificStream:', error);
                showError('Error al abrir stream espec√≠fico');
            }
        }

        // Funci√≥n para abrir el mejor stream (implementaci√≥n correcta desde streamed-replica.html)
        async function openBestStream(matchId, matchTitle) {
            try {
                console.log('üéØ Abriendo mejor stream para:', matchTitle);
                
                const match = currentMatches.find(m => m.id === matchId);
                console.log('üîç Match encontrado:', match);
                console.log('üîç Sources del match:', match?.sources);
                
                if (!match || !match.sources) {
                    showError('No hay streams disponibles');
                    return;
                }
                
                let bestStream = null;
                let maxViewers = 0;
                let spanishStream = null;
                let allStreams = [];
                
                // Buscar el stream con m√°s espectadores, priorizando espa√±ol
                for (const source of match.sources) {
                    try {
                        const response = await fetch(`https://streamed.pk/api/stream/${source.source}/${source.id}`);
                        const streams = await response.json();
                        
                        if (streams && streams.length > 0) {
                            streams.forEach(stream => {
                                allStreams.push(stream);
                                
                                // Priorizar streams en espa√±ol
                                const language = (stream.language || '').toLowerCase();
                                const embedUrl = (stream.embedUrl || '').toLowerCase();
                                const isSpanish = language === 'spanish' || embedUrl.includes('spanish');
                                
                                console.log(`üîç Stream ${stream.streamNo}: language="${language}", embedUrl="${embedUrl}", isSpanish=${isSpanish}`);
                                
                                if (isSpanish && !spanishStream) {
                                    spanishStream = stream;
                                    console.log('‚úÖ Encontrado stream en espa√±ol:', stream);
                                }
                                
                                // Buscar el stream con m√°s espectadores
                                if (stream.viewers && stream.viewers > maxViewers) {
                                    maxViewers = stream.viewers;
                                    bestStream = stream;
                                }
                            });
                        }
                    } catch (error) {
                        console.error(`Error loading stream for ${source.source}:`, error);
                    }
                }
                
                console.log(`üìä Total streams encontrados: ${allStreams.length}`);
                console.log(`üá™üá∏ Stream en espa√±ol encontrado:`, spanishStream);
                console.log(`üë• Stream con m√°s espectadores:`, bestStream);
                
                // Prioridad: 1) Espa√±ol, 2) Stream con espectadores, 3) Cualquier stream disponible
                let finalStream = spanishStream;
                if (!finalStream && bestStream && bestStream.viewers > 0) {
                    finalStream = bestStream;
                }
                if (!finalStream) {
                    // Usar cualquier stream disponible (el primero que encuentre)
                    finalStream = allStreams[0] || bestStream;
                }
                
                if (finalStream && finalStream.embedUrl) {
                    console.log('‚úÖ === Abriendo mejor stream ===');
                    console.log('‚úÖ finalStream.embedUrl:', finalStream.embedUrl);
                    console.log('‚úÖ matchTitle:', matchTitle);
                    console.log('‚úÖ Llamando a openStreamOverlay...');
                    openStreamOverlay(finalStream.embedUrl, matchTitle);
                } else {
                    console.error('‚ùå No se encontr√≥ un stream v√°lido en openBestStream');
                    console.log('‚ùå finalStream:', finalStream);
                    showError('No se encontr√≥ un stream v√°lido');
                }
                
            } catch (error) {
                console.error('Error opening best stream:', error);
                showError('Error al abrir stream');
            }
        }

        // Funci√≥n para abrir stream en overlay
        function openStreamOverlay(url, title = 'Stream') {
            console.log('üöÄ === INICIANDO openStreamOverlay ===');
            console.log('üì∫ URL del stream:', url);
            console.log('üìù T√≠tulo:', title);
            
            if (!url || url === 'undefined') {
                console.error('‚ùå URL de stream no v√°lida:', url);
                showError('URL de stream no v√°lida');
                return;
            }
            
            const overlay = document.getElementById('streamOverlay');
            const streamIframe = document.getElementById('streamIframe');
            const adContainer = document.getElementById('adContainer');
            const adIframe = document.getElementById('adIframe');
            const closeAdBtn = document.getElementById('closeAdBtn');
            const closeStreamBtn = document.getElementById('closeStreamBtn');
            const adTimer = document.getElementById('adTimer');
            const countdown = document.getElementById('countdown');
            
            console.log('üîç Elementos encontrados:');
            console.log('  - overlay:', !!overlay);
            console.log('  - streamIframe:', !!streamIframe);
            console.log('  - adContainer:', !!adContainer);
            console.log('  - adIframe:', !!adIframe);
            console.log('  - closeAdBtn:', !!closeAdBtn);
            console.log('  - closeStreamBtn:', !!closeStreamBtn);
            console.log('  - adTimer:', !!adTimer);
            console.log('  - countdown:', !!countdown);
            
            if (!overlay || !streamIframe) {
                console.error('‚ùå Elementos cr√≠ticos no encontrados');
                return;
            }
            
            // Limpiar cualquier timer anterior
            if (window.adTimer) {
                console.log('üßπ Limpiando timer anterior');
                clearInterval(window.adTimer);
            }
            
            console.log('üîÑ Reseteando elementos al estado inicial...');
            
            // Resetear todos los elementos al estado inicial
            adContainer.style.display = 'block';
            adTimer.style.display = 'block';
            closeAdBtn.style.display = 'none';
            closeStreamBtn.style.display = 'none';
            streamIframe.style.display = 'none';
            streamIframe.src = '';
            
            console.log('‚úÖ Elementos reseteados');
            
            // Resetear el mensaje del timer
            adTimer.innerHTML = 'Cargando publicidad... <span id="countdown">30</span>s';
            console.log('üìù Timer HTML regenerado');
            
            // Mostrar el overlay
            overlay.style.display = 'block';
            console.log('üëÅÔ∏è Overlay mostrado');
            
            // Bloquear scroll del body
            document.body.style.overflow = 'hidden';
            console.log('üîí Scroll bloqueado');
            
            // Cargar publicidad de Adsterra
            const adUrl = 'https://www.revenuecpmgate.com/mr0r2hndg?key=78bccdf65220327356e33416cb3393eb';
            console.log('üì¢ Cargando publicidad:', adUrl);
            adIframe.src = adUrl;
            
            // Event listeners para el iframe de publicidad
            adIframe.onload = function() {
                console.log('‚úÖ Publicidad cargada exitosamente');
            };
            
            adIframe.onerror = function() {
                console.error('‚ùå Error cargando publicidad');
            };
            
            // Contador de 30 segundos
            let seconds = 30;
            const countdownElement = document.getElementById('countdown');
            console.log('‚è±Ô∏è Iniciando contador de 30 segundos');
            console.log('üî¢ Elemento countdown encontrado:', !!countdownElement);
            
            if (!countdownElement) {
                console.error('‚ùå Elemento countdown no encontrado despu√©s de regenerar HTML');
                return;
            }
            
            countdownElement.textContent = seconds;
            console.log('üî¢ Contador inicializado en:', seconds);
            
            window.adTimer = setInterval(() => {
                seconds--;
                console.log('‚è∞ Contador:', seconds);
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    console.log('‚è∞ Contador terminado, limpiando timer');
                    clearInterval(window.adTimer);
                    window.adTimer = null;
                    
                    // Cambiar el mensaje y mostrar bot√≥n cerrar publicidad
                    adTimer.innerHTML = 'Publicidad lista - Puedes cerrar cuando quieras';
                    closeAdBtn.style.display = 'block';
                    console.log('‚úÖ Bot√≥n "Cerrar Publicidad" mostrado');
                    
                    // Guardar la URL del stream para cuando el usuario cierre la publicidad
                    window.pendingStreamUrl = url;
                    console.log('üíæ URL del stream guardada:', url);
                    
                    console.log('üé¨ Publicidad lista, esperando que el usuario cierre');
                }
            }, 1000);
            
            console.log('üöÄ === openStreamOverlay completado ===');
        }

        // Funci√≥n para cerrar publicidad y mostrar stream
        function closeAdAndShowStream() {
            console.log('üé¨ === closeAdAndShowStream ===');
            
            const streamIframe = document.getElementById('streamIframe');
            const adContainer = document.getElementById('adContainer');
            const adIframe = document.getElementById('adIframe');
            const closeAdBtn = document.getElementById('closeAdBtn');
            const closeStreamBtn = document.getElementById('closeStreamBtn');
            const adTimer = document.getElementById('adTimer');
            
            console.log('üîç Elementos encontrados en closeAdAndShowStream:');
            console.log('  - streamIframe:', !!streamIframe);
            console.log('  - adContainer:', !!adContainer);
            console.log('  - adIframe:', !!adIframe);
            console.log('  - closeAdBtn:', !!closeAdBtn);
            console.log('  - closeStreamBtn:', !!closeStreamBtn);
            console.log('  - adTimer:', !!adTimer);
            
            // Ocultar publicidad y mostrar stream
            adContainer.style.display = 'none';
            adTimer.style.display = 'none';
            closeAdBtn.style.display = 'none';
            closeStreamBtn.style.display = 'block';
            streamIframe.style.display = 'block';
            
            console.log('üîÑ Elementos ocultados/mostrados');
            
            // Cargar el stream real
            if (window.pendingStreamUrl) {
                console.log('üì∫ Cargando stream real:', window.pendingStreamUrl);
                streamIframe.src = window.pendingStreamUrl;
                window.pendingStreamUrl = null;
                console.log('‚úÖ Stream cargado, URL pendiente limpiada');
            } else {
                console.error('‚ùå No hay URL de stream pendiente');
            }
            
            console.log('üé¨ Publicidad cerrada, mostrando stream');
        }

        // Funci√≥n para cerrar stream overlay
        function closeStreamOverlay() {
            const overlay = document.getElementById('streamOverlay');
            const streamIframe = document.getElementById('streamIframe');
            const adIframe = document.getElementById('adIframe');
            const adContainer = document.getElementById('adContainer');
            const closeAdBtn = document.getElementById('closeAdBtn');
            const closeStreamBtn = document.getElementById('closeStreamBtn');
            const adTimer = document.getElementById('adTimer');
            
            // Limpiar timer si existe
            if (window.adTimer) {
                clearInterval(window.adTimer);
                window.adTimer = null;
            }
            
            // Ocultar el overlay
            overlay.style.display = 'none';
            
            // Limpiar los iframes
            streamIframe.src = '';
            adIframe.src = '';
            
            // Resetear elementos de publicidad
            adContainer.style.display = 'none';
            adTimer.style.display = 'none';
            closeAdBtn.style.display = 'none';
            closeStreamBtn.style.display = 'none';
            streamIframe.style.display = 'none';
            
            // Limpiar URL pendiente
            window.pendingStreamUrl = null;
            
            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
            
            console.log('üîí Cerrando stream overlay completamente');
        }
        
        // Poblar filtros
        function populateFilters(matches, sports = []) {
            const sportFilter = document.getElementById('sportFilter');
            const leagueFilter = document.getElementById('leagueFilter');
            
            // Limpiar filtros
            sportFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
            leagueFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
            
            // Poblar deportes desde la API
            if (sports.length > 0) {
                sports.forEach(sport => {
                    const option = document.createElement('option');
                    option.value = sport.id;
                    option.textContent = sport.name;
                    sportFilter.appendChild(option);
                });
            } else {
                // Fallback: obtener categor√≠as √∫nicas de los partidos
                const uniqueCategories = [...new Set(matches.map(m => m.category).filter(Boolean))];
                uniqueCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    sportFilter.appendChild(option);
                });
            }
            
            // Obtener categor√≠as √∫nicas para el filtro de liga (usando category como liga)
            const categories = [...new Set(matches.map(m => m.category).filter(Boolean))];
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                leagueFilter.appendChild(option);
            });
        }
        
        // Filtrar por deporte
        async function filterBySport() {
            const sportId = document.getElementById('sportFilter').value;
            if (!sportId) {
                displayMatches(currentMatches);
                return;
            }
            
            // Si es un ID num√©rico, hacer llamada a la API
            if (!isNaN(sportId)) {
                showLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/matches/${sportId}`);
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    
                    const data = await response.json();
                    currentMatches = data;
                    displayMatches(data);
                } catch (error) {
                    showError('Error al filtrar por deporte: ' + error.message);
                } finally {
                    showLoading(false);
                }
            } else {
                // Si es una categor√≠a, filtrar localmente
                const filtered = currentMatches.filter(match => match.category === sportId);
                displayMatches(filtered);
            }
        }
        
        // Filtrar por liga
        function filterByLeague() {
            const league = document.getElementById('leagueFilter').value;
            if (!league) {
                displayMatches(currentMatches);
                return;
            }
            
            const filtered = currentMatches.filter(match => match.category === league);
            displayMatches(filtered);
        }
        
        // Mostrar solo partidos de f√∫tbol
        function showFootballOnly() {
            if (currentMatches.length === 0) {
                showError('Primero carga los partidos');
                return;
            }
            
            const footballMatches = currentMatches.filter(match => match.category === 'football');
            displayMatches(footballMatches);
        }
        
        // Cargar todos los deportes disponibles
        async function loadAllSports() {
            console.log('=== CARGANDO TODOS LOS DEPORTES ===');
            showLoading(true);
            hideError();
            
            try {
                const sportsResponse = await fetch(`${API_BASE}/sports`);
                if (!sportsResponse.ok) throw new Error(`Error ${sportsResponse.status}`);
                
                const sports = await sportsResponse.json();
                console.log('Todos los deportes:', sports);
                
                // Mostrar informaci√≥n de deportes
                let sportsInfo = 'Deportes disponibles:\n';
                sports.forEach((sport, index) => {
                    sportsInfo += `${index + 1}. ${sport.name} (ID: ${sport.id})\n`;
                });
                
                showError(`‚úÖ ${sports.length} deportes encontrados. Revisa la consola para detalles.`);
                
                // Cargar partidos de cada deporte para ver cu√°les tienen partidos
                for (const sport of sports) {
                    try {
                        const response = await fetch(`${API_BASE}/matches/${sport.id}`);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`${sport.name}: ${data.length} partidos`);
                        }
                    } catch (error) {
                        console.log(`${sport.name}: Error cargando partidos`);
                    }
                }
                
            } catch (error) {
                console.error('Error cargando deportes:', error);
                showError('Error al cargar deportes: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Probar la API
        async function testAPI() {
            console.log('=== PROBANDO API ===');
            showLoading(true);
            hideError();
            
            try {
                // Probar endpoint de deportes
                console.log('Probando /sports...');
                const sportsResponse = await fetch(`${API_BASE}/sports`);
                console.log('Sports response:', sportsResponse.status, sportsResponse.ok);
                
                if (sportsResponse.ok) {
                    const sports = await sportsResponse.json();
                    console.log('Sports data:', sports);
                    showError(`‚úÖ Deportes OK: ${sports.length} deportes encontrados`);
                } else {
                    showError(`‚ùå Error deportes: ${sportsResponse.status}`);
                }
                
                // Probar endpoint de partidos en vivo
                console.log('Probando /matches/live...');
                const liveResponse = await fetch(`${API_BASE}/matches/live`);
                console.log('Live response:', liveResponse.status, liveResponse.ok);
                
                if (liveResponse.ok) {
                    const liveData = await liveResponse.json();
                    console.log('Live data:', liveData);
                    showError(`‚úÖ Partidos en vivo OK: ${liveData.length} partidos encontrados`);
                } else {
                    showError(`‚ùå Error partidos en vivo: ${liveResponse.status}`);
                }
                
            } catch (error) {
                console.error('Error en prueba de API:', error);
                showError(`‚ùå Error de conexi√≥n: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // Mostrar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Mostrar error
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Ocultar error
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Event listener para cerrar stream overlay con Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const overlay = document.getElementById('streamOverlay');
                if (overlay && overlay.style.display === 'block') {
                    closeStreamOverlay();
                }
            }
        });
        
        // Buscar por equipo
        function searchByTeam() {
            const searchTerm = document.getElementById('teamSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // Si no hay t√©rmino de b√∫squeda, mostrar todos los partidos del d√≠a
                displayMatches(currentMatches);
                return;
            }
            
            console.log('Buscando equipo:', searchTerm);
            
            // Filtrar partidos que contengan el t√©rmino de b√∫squeda en el t√≠tulo o equipos
            const filteredMatches = currentMatches.filter(match => {
                if (!match.title) return false;
                
                const title = match.title.toLowerCase();
                const homeTeam = match.teams?.home?.name?.toLowerCase() || '';
                const awayTeam = match.teams?.away?.name?.toLowerCase() || '';
                
                // Buscar en t√≠tulo, equipos home y away
                return title.includes(searchTerm) || 
                       homeTeam.includes(searchTerm) || 
                       awayTeam.includes(searchTerm);
            });
            
            console.log(`Encontrados ${filteredMatches.length} partidos para "${searchTerm}"`);
            
            // Mostrar resultados
            if (filteredMatches.length === 0) {
                const container = document.getElementById('matches');
                container.innerHTML = `<div class="error">No se encontraron partidos para "${searchTerm}"</div>`;
            } else {
                displayMatches(filteredMatches);
            }
        }
        
        // Limpiar b√∫squeda
        function clearSearch() {
            document.getElementById('teamSearch').value = '';
            displayMatches(currentMatches);
        }
        
        // Cargar partidos al iniciar
        window.onload = function() {
            loadMatches();
        }
    </script>
</body>
</html>